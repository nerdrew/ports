--- configure.orig	2010-08-18 14:56:27.000000000 +0900
+++ configure	2010-09-24 22:51:50.000000000 +0900
@@ -4938,7 +4938,7 @@
 
 
 case "$target_os" in #(
-  cygwin*|mingw*|darwin*) :
+  cygwin*|mingw*) :
     ac_cv_prog_ac_ct_OBJCOPY=":" ;; #(
   *) :
      ;;
@@ -6185,6 +6185,10 @@
 
 
 
+
+
+
+
 if test "$GCC:${warnflags+set}:no" = yes::no; then
     for wflag in -Wno-unused-parameter -Wno-parentheses -Wpointer-arith -Wwrite-strings \
 		 -Wno-missing-field-initializers -Wshorten-64-to-32 -Wno-long-long; do
@@ -6193,6 +6197,13 @@
     CFLAGS="$CFLAGS $wflag"
     { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $wflag is accepted" >&5
 $as_echo_n "checking whether $wflag is accepted... " >&6; }
+    if test "${ac_c_werror_flag+set}"; then
+  rb_c_werror_flag="$ac_c_werror_flag"
+else
+  unset rb_c_werror_flag
+fi
+ac_c_werror_flag=yes
+
     cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -6214,6 +6225,12 @@
 $as_echo "no" >&6; }
 fi
 rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+
+if test "${rb_c_werror_flag+set}"; then
+  ac_c_werror_flag="$rb_c_werror_flag"
+else
+  unset ac_c_werror_flag
+fi
     CFLAGS="$save_CFLAGS"
     save_CFLAGS=
 
@@ -6229,6 +6246,13 @@
     CFLAGS="$CFLAGS $wflag"
     { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether $wflag is accepted" >&5
 $as_echo_n "checking whether $wflag is accepted... " >&6; }
+    if test "${ac_c_werror_flag+set}"; then
+  rb_c_werror_flag="$ac_c_werror_flag"
+else
+  unset rb_c_werror_flag
+fi
+ac_c_werror_flag=yes
+
     cat confdefs.h - <<_ACEOF >conftest.$ac_ext
 /* end confdefs.h.  */
 
@@ -6250,10 +6274,74 @@
 $as_echo "no" >&6; }
 fi
 rm -f core conftest.err conftest.$ac_objext conftest.$ac_ext
+
+if test "${rb_c_werror_flag+set}"; then
+  ac_c_werror_flag="$rb_c_werror_flag"
+else
+  unset ac_c_werror_flag
+fi
     CFLAGS="$save_CFLAGS"
     save_CFLAGS=
 
 fi
+if test "$GCC" = yes; then
+    if test "$visibility_option" = yes; then
+	# RUBY_APPEND_OPTION(XCFLAGS, -fvisibility=hidden)
+	case " ${XCFLAGS-} " in #(
+  *' -fvisibility=hidden '*) :
+     ;; #(
+  '  ') :
+     XCFLAGS="-fvisibility=hidden" ;; #(
+  *) :
+     XCFLAGS="$XCFLAGS -fvisibility=hidden" ;;
+esac
+    else
+
+    save_LDFLAGS="$LDFLAGS"
+    LDFLAGS="$LDFLAGS '-Wl,-unexported_symbol,_Init_*'"
+    { $as_echo "$as_me:${as_lineno-$LINENO}: checking whether '-Wl" >&5
+$as_echo_n "checking whether '-Wl... " >&6; }
+    if test "${ac_c_werror_flag+set}"; then
+  rb_c_werror_flag="$ac_c_werror_flag"
+else
+  unset rb_c_werror_flag
+fi
+ac_c_werror_flag=yes
+
+    cat confdefs.h - <<_ACEOF >conftest.$ac_ext
+/* end confdefs.h.  */
+
+int
+main ()
+{
+
+  ;
+  return 0;
+}
+_ACEOF
+if ac_fn_c_try_link "$LINENO"; then :
+  visibility_option=ld
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: yes" >&5
+$as_echo "yes" >&6; }
+else
+  visibility_option=no
+	{ $as_echo "$as_me:${as_lineno-$LINENO}: result: no" >&5
+$as_echo "no" >&6; }
+fi
+rm -f core conftest.err conftest.$ac_objext \
+    conftest$ac_exeext conftest.$ac_ext
+
+if test "${rb_c_werror_flag+set}"; then
+  ac_c_werror_flag="$rb_c_werror_flag"
+else
+  unset ac_c_werror_flag
+fi
+    LDFLAGS="$save_LDFLAGS"
+    save_LDFLAGS=
+
+    fi
+    test "$visibility_option" = no || OBJCOPY=:
+fi
 
 test -z "${ac_env_CFLAGS_set}" -a -n "${cflags+set}" && eval CFLAGS="\"$cflags $ARCH_FLAG\""
 test -z "${ac_env_CXXFLAGS_set}" -a -n "${cxxflags+set}" && eval CXXFLAGS="\"$cxxflags $ARCH_FLAG\""
@@ -15416,8 +15504,10 @@
 	LIBRUBY_DLDFLAGS="$LIBRUBY_DLDFLAGS "'-install_name '${libprefix}'/$(LIBRUBY_SO)'
 	LIBRUBY_DLDFLAGS="$LIBRUBY_DLDFLAGS "'-current_version $(MAJOR).$(MINOR).$(TEENY)'
 	LIBRUBY_DLDFLAGS="$LIBRUBY_DLDFLAGS "'-compatibility_version $(ruby_version)'
-	LIBRUBY_DLDFLAGS="$LIBRUBY_DLDFLAGS "'-Wl,-unexported_symbol,_Init_*'
-	LIBRUBY_DLDFLAGS="$LIBRUBY_DLDFLAGS "'-Wl,-unexported_symbol,*_threadptr_*'
+	if test "$visibility_option" = ld; then
+	    LIBRUBY_DLDFLAGS="$LIBRUBY_DLDFLAGS "'-Wl,-unexported_symbol,_Init_*'
+	    LIBRUBY_DLDFLAGS="$LIBRUBY_DLDFLAGS "'-Wl,-unexported_symbol,*_threadptr_*'
+	fi
 	LIBRUBY_DLDFLAGS="$LIBRUBY_DLDFLAGS "' $(XLDFLAGS)'
 	LIBRUBY_SO='lib$(RUBY_SO_NAME).dylib'
 	LIBRUBY_ALIASES='lib$(RUBY_BASE_NAME).$(MAJOR).$(MINOR).dylib lib$(RUBY_INSTALL_NAME).dylib'
